DELIMITER //
CREATE PROCEDURE textbooksuggest (IN _match TEXT, _limit INT) 
BEGIN 
    
	
	DECLARE sObj INT;
	DECLARE sBookTitle VARCHAR(1024);

	DECLARE sscore DOUBLE;
	
	
	DECLARE lastrow INT DEFAULT 0; 
	
	DECLARE cur_table CURSOR FOR SELECT * FROM stb_view;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET lastrow = 1; 
      
    SET @_match = _match;
	SET @_limit = _limit;
	
	SET @iquery = CONCAT('create VIEW stb_view as 
							SELECT 	searchObj, searchOTitle, MATCH(searchTitle) AGAINST ("', @_match, '" IN BOOLEAN MODE) AS score 
							FROM 	vsf_search
							WHERE 	searchModule = "textbooks"
									AND MATCH(searchTitle) AGAINST ("', @_match, '" IN BOOLEAN MODE) > 0
							GROUP BY searchOTitle
							LIMIT 0 ,', @_limit);

	
	PREPARE pandog FROM @iquery;
	EXECUTE pandog;
	DEALLOCATE PREPARE pandog; 
	
	DROP TEMPORARY TABLE IF EXISTS tmp;
	CREATE TEMPORARY TABLE tmp(			
			bookId INT UNSIGNED, 
			bookTitle VARCHAR(1024),
			score DOUBLE UNSIGNED
	)ENGINE=MEMORY;  
	
	OPEN cur_table; 
	cursor_loop:LOOP
		FETCH cur_table INTO sObj, sBookTitle, sscore;
		
		IF lastrow=1 THEN LEAVE cursor_loop;
		END IF;

		
		
		INSERT INTO tmp VALUES (sObj, sBookTitle, sscore);
	END LOOP cursor_loop;
	CLOSE cur_table;  
  
    DROP VIEW stb_view; 
    SELECT * FROM tmp ORDER BY score DESC;
    DROP TEMPORARY TABLE IF EXISTS tmp;

END //
DELIMITER ;

CALL textbooksuggest('ruby IN BOOLEAN MODE', 5);